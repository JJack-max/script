services:
  pdns-init:
    image: powerdns/pdns-auth-49:latest
    container_name: pdns-init
    entrypoint: ["/bin/sh", "-c"]
    command: |
      set -e

      echo "[INIT] Creating /var/lib/powerdns ..."
      mkdir -p /var/lib/powerdns

      if [ ! -f /var/lib/powerdns/pdns.sqlite3 ]; then
        echo "[INIT] Creating sqlite db + schema..."
        sqlite3 /var/lib/powerdns/pdns.sqlite3 < /usr/share/doc/pdns-backend-sqlite3/schema.sqlite3.sql
      else
        echo "[INIT] sqlite db already exists, skipping schema init."
      fi

      echo "[INIT] Fixing permissions..."
      chown -R pdns:pdns /var/lib/powerdns

      echo "[INIT] Done."
    volumes:
      - pdns-data:/var/lib/powerdns
    networks:
      - pdns-net
    restart: "no"

  pdns:
    image: powerdns/pdns-auth-49:latest
    container_name: pdns
    restart: unless-stopped
    depends_on:
      - pdns-init
    command: >
      --launch=gsqlite3
      --gsqlite3-database=/var/lib/powerdns/pdns.sqlite3
      --api=yes
      --api-key=supersecret
      --webserver=yes
      --webserver-address=0.0.0.0
      --webserver-port=8081
      --webserver-allow-from=0.0.0.0/0
      --local-address=0.0.0.0
      --local-port=53
      --loglevel=4
    volumes:
      - pdns-data:/var/lib/powerdns
    networks:
      - pdns-net

  poweradmin:
    image: poweradmin/poweradmin:latest
    container_name: poweradmin
    restart: unless-stopped
    environment:
      DB_TYPE: sqlite
      PDNS_API_URL: http://pdns:8081
      PDNS_API_KEY: supersecret
      PA_CREATE_ADMIN: "1"
    networks:
      - pdns-net

volumes:
  pdns-data:

networks:
  pdns-net:
    driver: bridge
