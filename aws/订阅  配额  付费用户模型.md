## 问题 #366

一家公司的 **Web 应用** 由以下组件组成：

- Amazon API Gateway API  
- AWS Lambda（业务逻辑）  
- Amazon DynamoDB（数据存储）  
- Amazon Cognito 用户池（用户身份认证）  

现有情况：
- 应用已使用 **Cognito 用户池** 验证用户身份  
- 需要新增 **高级内容（Premium Content）**
- **只有已订阅用户才能访问高级内容**
- 要求：**最少的运营开销**

哪种解决方案可以满足这些要求？

A. 在 API Gateway API 上启用 API 缓存和限流  
B. 在 API Gateway API 上设置 AWS WAF，并创建规则过滤有订阅的用户  
C. 对 DynamoDB 表中的高级内容应用细粒度 IAM 权限  
D. 实施 API 使用计划和 API 密钥，以限制没有订阅的用户的访问  

---

## 正确答案
**👉 D**

---

## 解析

### 考点
- API Gateway 访问控制
- 订阅 / 配额 / 付费用户模型
- Cognito vs API Key 职责划分
- **最少运营开销**

---

## 为什么选 D

### ✅ API 使用计划 + API Key = 订阅用户访问控制（低运维）

**API Gateway 使用计划（Usage Plan）非常适合以下场景：**

1. 区分 **订阅 / 非订阅用户**
2. 控制 **谁可以访问哪些 API**
3. 限制请求频率 / 配额
4. **无需额外自定义逻辑，运维成本低**

---

### 1️⃣ API Key 用于“是否有订阅”的判断

- 只有 **订阅用户** 才会分配：
  - API Key
  - 绑定到 Usage Plan
- API Gateway 在入口直接校验：
  - ❌ 没有 API Key → 拒绝访问
  - ✅ 有 API Key → 放行

👉 **访问控制发生在最前端（API Gateway）**

---

### 2️⃣ 使用计划天然支持“付费 / 高级用户模型”

- 使用计划可配置：
  - 请求速率
  - 每日 / 每月配额
- 非订阅用户：
  - 不分配 API Key
  - 或绑定到低配额计划

👉 这是 **AWS 官方推荐的订阅式 API 方案**

---

### 3️⃣ 运维成本最低

- 无需：
  - 自定义 Lambda 鉴权逻辑
  - 自维护订阅判断规则
- 全部是 **托管能力**

👉 完美符合题目里的 **“最少运营开销”**

---

## 其他选项为什么错

### ❌ A. 启用 API 缓存和限流
- 作用是：
  - 提升性能
  - 防止流量突增
- ❌ **不能区分订阅 / 非订阅用户**
- ❌ 与访问控制无关

---

### ❌ B. 使用 AWS WAF 过滤订阅用户
- WAF 适合：
  - IP / 国家 / 请求模式
  - SQL 注入、XSS 防护
- ❌ **无法基于“是否订阅”这种业务属性**
- ❌ 运维复杂，规则维护成本高

---

### ❌ C. DynamoDB 细粒度 IAM 权限
- DynamoDB IAM：
  - 控制的是 **服务 / 角色**
  - 不是终端用户订阅状态
- ❌ 无法直接映射到 Web 用户订阅模型
- ❌ 架构设计错误（权限下沉过深）

---

## 一句话记忆
> **API 订阅 / 付费访问控制 → API Gateway 使用计划 + API Key**

### 考试秒杀版
> **要区分订阅用户、还要求低运维：直接上 API Key + Usage Plan**
