## 问题 #255（纠错后）

一家公司有一个**电子商务结账处理流程**，该流程会：
- 将订单写入数据库
- 调用服务来处理付款  

用户在结账过程中可能会遇到**超时**。  
当用户**重新提交结账请求**时，可能会**为同一笔交易创建多个唯一订单**。

解决方案架构师应如何**重构该结账流程以防止创建重复订单**？

A. 将订单消息发送到 Amazon Kinesis Data Firehose，由支付服务从 Firehose 中检索消息并处理订单。  
B. 使用 AWS CloudTrail 规则，根据记录的应用程序路径请求触发 AWS Lambda，由 Lambda 查询数据库并调用支付服务。  
C. 将订单存储在数据库中，并将订单号发送到 Amazon SNS，由支付服务轮询 SNS 并处理订单。  
D. 将订单存储在数据库中，并将包含订单号的消息发送到 **Amazon SQS FIFO 队列**。支付服务从队列中检索消息并处理订单，处理完成后删除消息。

---

## 正确答案
**👉 D**

---

## 解析

### 考点
- **幂等性（Idempotency）**
- 防止 **重复订单 / 重复支付**
- 消息队列的 **Exactly-once / 顺序 / 去重能力**

---

### 为什么选 D（SQS FIFO）

**Amazon SQS FIFO 队列的关键能力：**

- **Exactly-once processing**
  - 通过 `MessageDeduplicationId`
  - 同一订单号只会被处理一次
- **严格顺序保证**
- **天然解耦**
  - Web 层 ≠ 支付层
- 即使用户重复提交请求：
  - 相同订单号的消息会被**自动去重**
  - 不会生成多个订单

👉 这是 **AWS 官方推荐的“防重复提交 / 防重复消费”标准模式**

---

### 其他选项为什么错

#### ❌ A. Kinesis Data Firehose
- 适合：
  - 日志
  - 流数据采集
- ❌ 不保证消息只被处理一次
- ❌ 不适合事务型订单处理

---

#### ❌ B. CloudTrail + Lambda
- CloudTrail 用于：
  - API 审计
- ❌ 不用于业务流程编排
- 架构复杂、成本高、语义错误

---

#### ❌ C. SNS
- SNS 是：
  - **发布 / 订阅**
- 消息可能被：
  - 多次投递
  - 多订阅者消费
- ❌ **无法防止重复订单**

---

## 一句话记忆
> **防止重复订单 / 重复支付 → SQS FIFO + 订单号去重**

考试秒杀版：

> **看到“重复提交 / 幂等性” → 直接选 SQS FIFO**
